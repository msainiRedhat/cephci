#############################################################################
# - Automation support for upgrade from RHCS4 to RHCS5 cluster with RGW tests
#
# Test steps:
# ---------------------------------------------------------------------
# - Deploy bare-metal Nautilus Ceph cluster using CDN RPMS with lvm osd scenario
# - Run RGW tests
# - Convert the cluster to containerized using ceph-ansible
# - Upgrade to Pacific using ceph-ansible
# - Run RGW tests after upgrade
#
#############################################################################
tests:
- test:
    name: install ceph pre-requisites
    module: install_prereq.py
    abort-on-fail: true

- test:
    name: ceph ansible install rhcs 4.x from cdn
    polarion-id: CEPH-83573588
    module: test_ansible.py
    config:
      use_cdn: true
      build: '4.x'
      ansi_config:
        ceph_origin: repository
        ceph_repository: rhcs
        ceph_repository_type: cdn
        ceph_rhcs_version: 4
        ceph_stable_release: nautilus
        osd_scenario: lvm
        osd_auto_discovery: false
        ceph_stable_rh_storage: true
        ceph_docker_image: "rhceph/rhceph-4-rhel8"
        ceph_docker_image_tag: "latest"
        ceph_docker_registry: "registry.redhat.io"
        copy_admin_key: true
        #radosgw_num_instances: 2
        dashboard_admin_user: admin
        dashboard_admin_password: p@ssw0rd
        grafana_admin_user: admin
        grafana_admin_password: p@ssw0rd
        node_exporter_container_image: registry.redhat.io/openshift4/ose-prometheus-node-exporter:v4.6
        grafana_container_image: registry.redhat.io/rhceph/rhceph-4-dashboard-rhel8:4
        prometheus_container_image: registry.redhat.io/openshift4/ose-prometheus:v4.6
        alertmanager_container_image: registry.redhat.io/openshift4/ose-prometheus-alertmanager:v4.6
    desc: deploy ceph containerized 4.x cdn setup using ceph-ansible
    destroy-cluster: false
    abort-on-fail: true

- test:
    name: check-ceph-health
    module: exec.py
    config:
      commands:
        - "ceph -s"
        - "ceph versions"
      sudo: true
    desc: check for ceph status and version

# switch from rpm to container
- test:
    name: switch-from-non-containerized-to-containerized-ceph-daemons
    polarion-id: CEPH-83573510
    module: switch_rpm_to_container.py
    abort-on-fail: true
